---
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export const getStaticPaths = (async ({ paginate }) => {
  const posts = (await getCollection('posts')).sort(
    (a, b) => (b.data.date?.valueOf() ?? 0) - (a.data.date?.valueOf() ?? 0)
  );
  return paginate(posts, { pageSize: 12 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

function getExcerpt(body: string, maxLen = 100): string {
  const text = body.replace(/<[^>]+>/g, '').replace(/&[a-z]+;/gi, ' ').replace(/\s+/g, ' ').trim();
  if (text.length <= maxLen) return text;
  return text.slice(0, maxLen).replace(/\s\S*$/, '') + 'â€¦';
}

function getReadingTime(body: string): number {
  const text = body.replace(/<[^>]+>/g, '').replace(/&[a-z]+;/gi, ' ').replace(/\s+/g, ' ').trim();
  return Math.max(1, Math.round(text.length / 500));
}

const totalPages = page.lastPage;
const currentPage = page.currentPage;
---

<BaseLayout title={currentPage === 1 ? 'ë¸”ë¡œê·¸' : `ë¸”ë¡œê·¸ - ${currentPage}í˜ì´ì§€`} description="ì„œìš¸ëŒ€ ìœ¤ì›ì¥ì´ ì§ì ‘ ì“°ëŠ” ì¹˜ê³¼ ê±´ê°• ë¸”ë¡œê·¸. ì¶©ì¹˜, ì„í”Œë€íŠ¸, ì‚¬ë‘ë‹ˆ, ì‡ëª¸ ì§ˆí™˜ ë“± í™˜ìë“¤ì´ ìì£¼ ë¬»ëŠ” ì¹˜ê³¼ ì •ë³´ë¥¼ ì •í™•í•˜ê³  ì‰½ê²Œ ì „í•©ë‹ˆë‹¤.">
  <section class="py-16">
    <div class="max-w-5xl mx-auto px-4 sm:px-6">
      <div class="text-center mb-12 anim-fade-up">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4">ë¸”ë¡œê·¸</h1>
        <p class="text-lg text-gray-600">ì •í™•í•˜ê³ , ì‰½ê²Œ ì´í•´ë˜ê³ , ë¯¿ì„ ìˆ˜ ìˆëŠ” ì¹˜ê³¼ ì •ë³´</p>
      </div>

      <!-- ê²€ìƒ‰ -->
      <div class="mb-10 max-w-lg mx-auto anim-fade-up">
        <div class="relative">
          <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <input
            id="blog-search"
            type="text"
            placeholder="ê¶ê¸ˆí•œ ì¹˜ê³¼ ì£¼ì œë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”"
            class="w-full pl-12 pr-4 py-3 rounded-xl border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none text-sm transition-all bg-white"
          />
        </div>
        <div id="search-results" class="mt-4 hidden"></div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        {page.data.map((post, i) => (
          <a href={`/posts/${post.slug}/`} class={`anim-fade-up anim-delay-${Math.min(i + 1, 3)} bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all hover:-translate-y-0.5 group border border-gray-100 flex flex-row`}>
            <div class="hidden sm:block sm:w-32 md:w-40 flex-shrink-0 overflow-hidden bg-gradient-to-br from-teal-50 to-cyan-50">
              {post.data.image?.path ? (
                <img
                  src={post.data.image.path}
                  alt={post.data.image.alt || post.data.title}
                  loading="lazy"
                  class="w-full h-full object-cover"
                />
              ) : (
                <div class="w-full h-full min-h-[160px] flex items-center justify-center">
                  <div class="text-5xl">ğŸ“</div>
                </div>
              )}
            </div>
            <div class="p-5 sm:p-6 flex flex-col justify-center flex-1 min-w-0">
              <div class="flex items-center gap-3 mb-3 flex-wrap">
                {post.data.categories?.[0] && (
                  <span class="bg-brand/10 text-brand px-3 py-0.5 rounded-full text-xs font-semibold">{post.data.categories[0]}</span>
                )}
                {post.data.date && (
                  <span class="text-xs text-gray-400">{post.data.date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                )}
                <span class="text-xs text-gray-400">{getReadingTime(post.body)}ë¶„ ì½ê¸°</span>
              </div>
              <h3 class="text-lg font-bold text-gray-900 mb-2 group-hover:text-brand transition-colors leading-snug">{post.data.title}</h3>
              <p class="text-gray-500 text-sm leading-relaxed line-clamp-2">{getExcerpt(post.body)}</p>
              <div class="flex items-center text-brand font-semibold mt-3 text-sm group-hover:gap-2 transition-all">
                <span>ë” ì½ê¸° â†’</span>
              </div>
            </div>
          </a>
        ))}
      </div>

      {page.data.length === 0 && (
        <p class="text-center text-gray-500 py-20">ì•„ì§ ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      )}

      <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
      {totalPages > 1 && (
        <nav id="pagination-nav" class="mt-16 flex items-center justify-center gap-2" aria-label="í˜ì´ì§€ ì´ë™">
          {page.url.prev ? (
            <a href={page.url.prev} class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">
              â† ì´ì „
            </a>
          ) : (
            <span class="px-3 py-2 rounded-lg text-sm font-medium text-gray-300 cursor-not-allowed">
              â† ì´ì „
            </span>
          )}

          {Array.from({ length: totalPages }, (_, i) => i + 1).map((num) => {
            const url = num === 1 ? '/posts/' : `/posts/${num}/`;
            const isActive = num === currentPage;
            return (
              <a
                href={url}
                class={`w-10 h-10 flex items-center justify-center rounded-lg text-sm font-semibold transition-colors ${
                  isActive
                    ? 'bg-brand text-white'
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
                aria-current={isActive ? 'page' : undefined}
              >
                {num}
              </a>
            );
          })}

          {page.url.next ? (
            <a href={page.url.next} class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">
              ë‹¤ìŒ â†’
            </a>
          ) : (
            <span class="px-3 py-2 rounded-lg text-sm font-medium text-gray-300 cursor-not-allowed">
              ë‹¤ìŒ â†’
            </span>
          )}
        </nav>
      )}

      <div id="post-count" class="text-center mt-6 text-sm text-gray-400">
        ì´ {page.total}ê°œì˜ ê¸€
      </div>
    </div>
  </section>

  <script>
    const input = document.getElementById('blog-search') as HTMLInputElement;
    const resultsEl = document.getElementById('search-results')!;
    const cardGrid = document.querySelector('.grid.md\\:grid-cols-2') as HTMLElement;
    const paginationNav = document.getElementById('pagination-nav');
    const postCount = document.getElementById('post-count');
    let posts: any[] = [];
    let loaded = false;

    async function loadIndex() {
      if (loaded) return;
      const res = await fetch('/search.json');
      posts = await res.json();
      loaded = true;
    }

    input?.addEventListener('focus', loadIndex);

    input?.addEventListener('input', async () => {
      await loadIndex();
      const q = input.value.trim().toLowerCase();

      if (!q) {
        resultsEl.classList.add('hidden');
        resultsEl.innerHTML = '';
        if (cardGrid) cardGrid.style.display = '';
        if (paginationNav) paginationNav.style.display = '';
        if (postCount) postCount.style.display = '';
        return;
      }

      const matches = posts.filter((p: any) =>
        p.title.toLowerCase().includes(q) ||
        p.description.toLowerCase().includes(q) ||
        p.excerpt.toLowerCase().includes(q) ||
        p.tags.some((t: string) => t.toLowerCase().includes(q)) ||
        p.categories.some((c: string) => c.toLowerCase().includes(q))
      ).slice(0, 12);

      if (cardGrid) cardGrid.style.display = 'none';
      if (paginationNav) paginationNav.style.display = 'none';
      if (postCount) postCount.style.display = 'none';
      resultsEl.classList.remove('hidden');

      if (matches.length === 0) {
        resultsEl.innerHTML = `<p class="text-center text-gray-400 py-12">"${input.value}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>`;
        return;
      }

      const formatDate = (iso: string) => {
        const d = new Date(iso);
        return d.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
      };

      resultsEl.innerHTML = `
        <p class="text-sm text-gray-400 mb-4">${matches.length}ê°œì˜ ê²€ìƒ‰ ê²°ê³¼</p>
        <div class="flex flex-col gap-3">
          ${matches.map((p: any) => `
            <a href="/posts/${p.slug}/" class="block bg-white rounded-xl px-5 py-4 border border-gray-100 hover:border-[#3FB8D3]/40 hover:shadow-md transition-all group">
              <h3 class="font-bold text-gray-900 group-hover:text-[#3FB8D3] transition-colors leading-snug mb-1">${highlight(p.title, q)}</h3>
              <p class="text-gray-500 text-sm line-clamp-1 mb-2">${highlight(p.excerpt.slice(0, 120), q)}</p>
              <div class="flex items-center gap-2 text-xs text-gray-400">
                ${p.categories[0] ? `<span class="text-[#3FB8D3] font-medium">${p.categories[0]}</span><span>Â·</span>` : ''}
                ${p.date ? `<span>${formatDate(p.date)}</span><span>Â·</span>` : ''}
                <span>${p.readingTime}ë¶„ ì½ê¸°</span>
              </div>
            </a>
          `).join('')}
        </div>
      `;
    });

    function highlight(text: string, q: string) {
      if (!q) return text;
      const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(re, '<mark class="bg-yellow-100 text-inherit rounded px-0.5">$1</mark>');
    }
  </script>
</BaseLayout>
