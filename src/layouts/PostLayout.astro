---
import BaseLayout from './BaseLayout.astro';

interface Props {
  title: string;
  description?: string;
  date?: Date;
  image?: string;
  tags?: string[];
}

const { title, description, date, image, tags = [] } = Astro.props;
---

<BaseLayout title={title} description={description} image={image} type="article" publishedDate={date} tags={tags}>
  <article class="py-12 md:py-20">
    <div class="max-w-6xl mx-auto px-4 sm:px-6">
      <!-- í—¤ë” -->
      <header class="mb-10 pb-8 border-b border-gray-200 max-w-3xl">
        {tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-4">
            {tags.map((tag) => (
              <span class="bg-brand-bg text-brand text-xs font-semibold px-3 py-1 rounded-full">{tag}</span>
            ))}
          </div>
        )}
        <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 mb-4 leading-tight">{title}</h1>
        <div class="flex items-center gap-3">
          <img src="/img/avatar.png" alt="ì„œìš¸ëŒ€ ìœ¤ì›ì¥" class="w-7 h-7 rounded-full object-cover ring-2 ring-brand-bg" />
          <div class="flex items-center gap-3 text-sm text-gray-400">
            <span class="font-medium text-gray-600">ì„œìš¸ëŒ€ ìœ¤ì›ì¥</span>
            {date && (
              <>
                <span class="text-gray-300">Â·</span>
                <time datetime={date.toISOString()}>
                  {date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}
                </time>
              </>
            )}
          </div>
        </div>
      </header>

      <div class="lg:grid lg:grid-cols-[minmax(0,3fr)_220px] lg:gap-12">
        <!-- ë³¸ë¬¸ -->
        <div>
          <div class="post-content">
            <slot />
          </div>

          <!-- í•˜ë‹¨ -->
          <footer class="mt-16 pt-8 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <a href="/posts/" class="inline-flex items-center gap-2 text-brand font-semibold hover:gap-3 transition-all">
              â† ëª¨ë“  ê¸€ ë³´ê¸°
            </a>
            <a href="https://blog.naver.com/studytosurvive" target="_blank" rel="noopener noreferrer"
              class="text-sm text-gray-400 hover:text-brand transition-colors">
              ğŸ“˜ ë„¤ì´ë²„ ë¸”ë¡œê·¸ì—ì„œë„ ì½ê¸°
            </a>
          </footer>
        </div>

        <!-- ëª©ì°¨ (ë°ìŠ¤í¬í†±) -->
        <aside class="hidden lg:block">
          <nav id="toc" class="sticky top-24">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">ëª©ì°¨</p>
            <ul id="toc-list" class="space-y-1.5 text-[0.8rem] leading-snug border-l-2 border-gray-100 pl-3">
            </ul>
          </nav>
        </aside>
      </div>
    </div>
  </article>

  <script>
    function buildTOC() {
      const content = document.querySelector('.post-content');
      const tocList = document.getElementById('toc-list');
      if (!content || !tocList) return;

      const headings: { el: Element; text: string; level: number }[] = [];

      content.querySelectorAll('h2, h3').forEach((el) => {
        const text = el.textContent?.trim();
        if (!text) return;
        if (!el.id) el.id = text.replace(/\s+/g, '-').replace(/[^\wê°€-í£-]/g, '').toLowerCase() || `heading-${headings.length}`;
        headings.push({ el, text, level: el.tagName === 'H2' ? 2 : 3 });
      });

      content.querySelectorAll('.se-fs-fs19').forEach((el) => {
        const text = el.textContent?.trim();
        if (!text || text === '\u200B') return;
        const parent = el.closest('.se-text-paragraph') || el.parentElement;
        if (!parent) return;
        if (!parent.id) parent.id = text.replace(/\s+/g, '-').replace(/[^\wê°€-í£-]/g, '').toLowerCase() || `heading-${headings.length}`;
        headings.push({ el: parent, text, level: 2 });
      });

      if (headings.length === 0) {
        const toc = document.getElementById('toc');
        if (toc) toc.style.display = 'none';
        return;
      }

      headings.forEach(({ el, text, level }) => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        const targetId = (el.closest('.se-text-paragraph') || el).id || el.id;
        a.href = `#${targetId}`;
        a.textContent = text.replace(/^[^\wê°€-í£]+/, '').substring(0, 30);
        a.className = `block py-1 text-gray-400 hover:text-brand transition-colors truncate ${level === 3 ? 'pl-3' : ''}`;
        a.dataset.tocTarget = targetId;
        li.appendChild(a);
        tocList.appendChild(li);
      });

      const tocLinks = tocList.querySelectorAll('a[data-toc-target]');
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              tocLinks.forEach((l) => l.classList.remove('text-brand', 'font-semibold'));
              const active = tocList.querySelector(`a[data-toc-target="${entry.target.id}"]`);
              if (active) {
                active.classList.remove('text-gray-400');
                active.classList.add('text-brand', 'font-semibold');
              }
            }
          });
        },
        { rootMargin: '-80px 0px -60% 0px', threshold: 0 }
      );

      headings.forEach(({ el }) => {
        const target = el.closest('.se-text-paragraph') || el;
        if (target.id) observer.observe(target);
      });
    }

    buildTOC();
  </script>

  <style is:global>
    .post-content {
      font-size: 1.05rem;
      line-height: 1.9;
      color: #334155;
      word-break: keep-all;
      overflow-wrap: break-word;
    }

    /* ===== ë„¤ì´ë²„ ë¸”ë¡œê·¸ HTML ì˜¤ë²„ë¼ì´ë“œ ===== */

    .post-content .naver-post,
    .post-content .se-main-container {
      max-width: 100%;
    }

    .post-content .se-component {
      margin-bottom: 0.15rem;
    }

    .post-content .se-text-paragraph {
      margin: 0;
      padding: 0;
      font-family: inherit !important;
      font-size: 1.05rem !important;
      line-height: 1.9 !important;
      color: #334155 !important;
    }

    .post-content .se-text-paragraph-align-center {
      text-align: center;
    }

    .post-content .se-fs-fs16 {
      font-size: 1.05rem !important;
    }

    /* ë¹ˆ ì¤„ (â€‹ zero-width space) ë†’ì´ ì¶•ì†Œ */
    .post-content .se-text-paragraph:only-child span:only-child:empty,
    .post-content .se-text-paragraph span[style=""]:only-child {
      display: block;
      line-height: 0.8;
    }

    /* ì†Œì œëª© (ë„¤ì´ë²„ fs19) */
    .post-content .se-fs-fs19 {
      font-size: 1.4rem !important;
      font-weight: 800 !important;
      color: #0f172a !important;
      letter-spacing: -0.02em;
    }

    .post-content .se-text-paragraph:has(.se-fs-fs19) {
      margin-top: 1rem !important;
      margin-bottom: 0.25rem !important;
      padding: 0.6rem 0;
    }

    .post-content .se-ff-nanummyeongjo {
      font-family: inherit !important;
    }

    /* ì¸ë¼ì¸ color ì˜¤ë²„ë¼ì´ë“œ */
    .post-content .se-text-paragraph span[style*="color:#000000"] {
      color: #334155 !important;
    }

    /* ===== ì´ë¯¸ì§€ - í™•ì‹¤í•œ ê°€ìš´ë° ì •ë ¬ ===== */

    .post-content .se-component.se-image {
      display: flex;
      justify-content: center;
    }

    .post-content .se-component-content {
      width: 100%;
    }

    .post-content .se-section-image {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 2rem auto !important;
    }

    .post-content .se-section-image[style*="max-width"] {
      margin-left: auto !important;
      margin-right: auto !important;
    }

    .post-content .se-module-image {
      display: flex;
      justify-content: center;
      width: 100%;
    }

    .post-content .se-image-resource {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.07);
      display: block;
      margin: 0 auto;
    }

    .post-content .se-module-image-link {
      display: block;
      cursor: default;
      text-align: center;
    }

    /* ìº¡ì…˜ */
    .post-content .se-caption {
      text-align: left;
      margin-top: 0.75rem;
      margin-bottom: 0;
      width: 100%;
    }

    .post-content .se-caption p {
      font-size: 0.8rem !important;
      color: #94a3b8 !important;
      line-height: 1.55 !important;
      text-align: left !important;
    }

    .post-content .se-caption a {
      color: #94a3b8 !important;
      font-size: 0.75rem;
    }

    /* êµ¬ë¶„ì„  */
    .post-content .se-hr {
      border: none;
      border-top: 1px solid #e2e8f0;
      margin: 2.5rem 0;
    }

    /* OG ë§í¬ ì¹´ë“œ */
    .post-content .se-oglink-info {
      display: block;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin: 0.75rem auto;
      max-width: 480px;
      text-decoration: none;
      transition: all 0.2s;
      background: #f8fafc;
    }

    .post-content .se-oglink-info:hover {
      border-color: #3FB8D3;
      box-shadow: 0 2px 12px rgba(76,189,196,0.1);
    }

    .post-content .se-oglink-title {
      display: block;
      font-size: 0.95rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.25rem;
    }

    .post-content .se-oglink-summary {
      font-size: 0.82rem;
      color: #64748b;
      margin: 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .post-content .se-oglink-url {
      font-size: 0.75rem;
      color: #94a3b8;
      margin: 0.3rem 0 0;
    }

    /* í•˜ì´ë¼ì´íŠ¸ í…ìŠ¤íŠ¸ */
    .post-content [style*="background-color:#ffef34"] {
      background: linear-gradient(transparent 55%, #fef08a 55%) !important;
      padding: 0 3px;
    }

    /* ë°‘ì¤„ + êµµì€ ê°•ì¡° */
    .post-content u b,
    .post-content b u {
      text-decoration: none;
      background: linear-gradient(transparent 85%, #3FB8D3 85%);
      padding-bottom: 2px;
    }

    /* ===== ì¼ë°˜ ë§ˆí¬ë‹¤ìš´ ì½˜í…ì¸  (ë¯¸ë˜ ê¸€ìš©) ===== */

    .post-content h2 {
      font-size: 1.5rem;
      font-weight: 800;
      color: #0f172a;
      margin-top: 3rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #f1f5f9;
    }

    .post-content h3 {
      font-size: 1.2rem;
      font-weight: 700;
      color: #0f172a;
      margin-top: 2rem;
      margin-bottom: 0.5rem;
    }

    .post-content p {
      margin-bottom: 1rem;
    }

    .post-content ul, .post-content ol {
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .post-content li {
      margin-bottom: 0.4rem;
    }

    .post-content a {
      color: #3FB8D3;
      text-decoration: underline;
      text-underline-offset: 3px;
      text-decoration-color: rgba(76,189,196,0.3);
    }

    .post-content a:hover {
      color: #2DA3BD;
      text-decoration-color: #2DA3BD;
    }

    .post-content blockquote {
      border-left: 3px solid #3FB8D3;
      padding-left: 1rem;
      color: #64748b;
      font-style: italic;
      margin: 1.5rem 0;
    }

    .post-content img {
      max-width: 100%;
      height: auto;
      border-radius: 12px;
    }

    .post-content strong {
      color: #0f172a;
    }
  </style>
</BaseLayout>
